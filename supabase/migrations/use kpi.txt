"use client";

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import {
    getKPIYear,
    updateManHours,
    saveMetric,
    deleteMetric,
    type KPIData,
    type KPIMetric
} from "@/lib/actions/kpi-actions";
import { toast } from "sonner";

export function useKPI(year: number) {
    const queryClient = useQueryClient();
    const queryKey = ["kpi", year];

    // Fetch Data
    const { data, isLoading } = useQuery({
        queryKey,
        queryFn: () => getKPIYear(year),
    });

    // Update Man Hours
    const updateHoursMutation = useMutation({
        mutationFn: async (hours: number) => await updateManHours(year, hours),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey });
            toast.success("Man Hours updated");
        },
    });

    // Save Metric
    const saveMetricMutation = useMutation({
        mutationFn: async (metric: Partial<KPIMetric>) => await saveMetric(year, metric),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey });
            toast.success("Metric saved");
        },
    });

    // Delete Metric
    const deleteMetricMutation = useMutation({
        mutationFn: async (id: string) => await deleteMetric(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey });
            toast.success("Metric deleted");
        },
    });

    return {
        data,
        isLoading,
        updateManHours: updateHoursMutation.mutate,
        saveMetric: saveMetricMutation.mutate,
        deleteMetric: deleteMetricMutation.mutate,
    };
}